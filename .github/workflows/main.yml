name: Data Processing Service

on:
  workflow_dispatch:
    inputs:
      job_type:
        description: 'Type of job to run'
        required: true
        default: 'process_pdf'
  push:
    branches: [ main ]

jobs:
  process-data:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install uv
      uses: astral-sh/setup-uv@v1

    - name: Install Dependencies & Package
      run: |
        uv sync --all-extras --dev
        # ติดตั้งตัวโปรเจกต์เองเพื่อให้เรียกใช้ app.xxx ได้แน่นอน
        uv pip install -e . 

    - name: Run Intelligent Processing
      env:
        JOB_TYPE: ${{ github.event.inputs.job_type || 'process_pdf' }}
      run: |
        # รันและบันทึก log แบบละเอียดเพื่อการวิเคราะห์
        uv run python -m app.main > processing.log 2>&1 || (cat processing.log && exit 1)
        
    - name: Upload Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: final-output
        path: |
          output/
          processing.log
